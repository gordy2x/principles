---
title: "Four principles for improved statistical ecology: a worked example for species richness in wetland mesocosms"
output: html_document
---


The study used a six-year dataset from a wild nest-box population of Blue Tits to examine the relationship of hatching date with the expression of carotenoid-based colouration in nestlings. Considering decreasing caterpillar abundance in the second half of the breeding season as well as the predictions of the parental quality hypothesis (Verhulst & Nilsson 2008), the expectation was that the expression of nestlings carotenoid-based colouration should be negatively correlated with hatching date. Moreover, Blue Tit nestlings, contrary to most bird species, including the Great Tit (Isaksson et al. 2008), are sexually dichromatic in both breast and tail feathers, with greater elaboration in males (Jacot & Kempenaers 2007). This might suggest the signalling role of juvenile male colouration and hence its greater condition dependence. Therefore, the study also predicted a sex-specific pattern, with this association between hatching date and colouration more pronounced in males.

Data for this study were collected during six consecutive breeding seasons, beginning in 2011. During this period, several experiments were conducted in the study population, but to avoid their potential influence on this study we included only data from non-manipulated nests, and (in some nests in 2011-2013) cross-fostered nests in which the brood size was not manipulated. Each year, nest-boxes were regularly inspected from mid-April and the laying date, number of eggs and hatching date were recorded. Considering the potential signalling role of carotenoid-based colouration, we used the avian tetrahedral colour space (TCS) model (Goldsmith 1990, Endler & Mielke 2005) allowing for the incorporation of the visual system of the signal receiver (Hart et al. 2000). The model expresses each reflectance measurement as a point in a tetrahedral space, in which the tetrahedral vertices correspond to maximum relative stimulations of four bird retinal cones (Stoddard & Prum 2008). The variables of interest here are those most related to Blue tit signalling: UV chroma and feather brightness.

The example below is a simplified portion of the full analysis in Janas et al. (2019).

## Principle 1. First, define a focused research question, then plan sampling and analysis to answer it

### 1A – Define your research question

#### FINER

 - **Feasible** - There are resources and logistics in place to allow for nestlings' sampling within the long-term Gotland project. 

 - **Interesting** -   Colour signalling is attracting ample interest in evolutionary biology. Mechanistic studies that probe possible physiological mechanisms (such as dependence of colour on nutritional/environmental variability) are the most promising in finding the relevant underlying processes. 
 
 - **Novel** -   The study is the first offering such a substantial sample size and data collected in a wild population.
 
 - **Ethical** - Tiny feather samples used in subsequent measurements can be collected without excerting too much stress on the birds.
 
 - **Relevant** - The biology of the Blue tit is still poorly understood - even though it's a model species. We also have little understanding of the mechanisms generating colour variation in animals. 

#### Predictions

- Birds hatched later in the season will have access to food less abundant in carotenoids, and therefore will have darker feathers with higher UV chroma. 
- Predicted relationship will be more pronounced in males.


#### PECO

- **Population** - Wild population of Blue tits on the Swedish island of Gotland.
- **Exposure** - Correlative study - response measured relative to environmental variation linked to date of hatching.
- **Comparison** - Response variables evaluated in a continuous gradient of variation linked to the natural range of hatching dates.
- **Outcome** - Feather colouration (UV chroma, brightness).


### 1B – Match data collection to research aims

The sampling is summarised in Figure 2 (or 1B?)


#### Field Sampling 

1. Nestlings were sampled in all identified broods - all nestlings in each nest were sampled for 3-5 breast feathers 14 days after hatching, which were then mounted on blackened paper for further measurements.
2. Natural distribution of hatching dates led to the majority of nests being sampled within medium hatching dates.

#### Manipulative Experiment

In years where cross-fostering was used in nests, the nests in a cross-fostered dyad were matched by hatching date (+- 1 day) and clutch size (+- 1 egg). In such years all nests that could be matched in pairs were used, with matching occuring between randomly selected nests.

### 1C – Plan analysis and consider registration


#### Model

- (Generalised) linear mixed model with colour variables as outcome, fixed effects for nestling sex and body weight on day 14 post-hatching to control for these, and random effect for year, nest of origin and nest of rearing (the two are the same in years without cross-fostering).
- Outcome type (normal, log transfomed etc.), and relationship type (linear, quadratic) to be determined with reference to residual plots.


#### Primary Effects of interest (with confidence intervals)

- Correlation of **hatching date** with the measured colour variables, , controlling for nuissance variables and random effects.
- Effect of **sex** on the direction of the relationship between colour and **hatching date** (interaction), controlling for nuissance variables and random effects. 


#### Multiple testing

- No multiple-testing issues requiring additional steps (i.e., not captured by random effects and their hierarchical structure).


## Principle 2. Develop a model that accounts for the distribution and dependence of your data

### 2A – Model dependence

We two main sources of dependence

1. Nestlings come from different breeding seasons that have more or less unique environmental conditions. We will account for this by including a random effect for year.
2. Nestlings come from the same nest, and in some years, from the same nest of rearing (half of brood exchanged in pairs of nests). We will account for this by including a random effect for nest of origin and nest of rearing.

#### Read in blue tit data

```{r}
caro_data <- read.csv("../data/carotenoids.csv", sep = ";")

# turn sex into a factor
caro_data$SEX <- as.factor(caro_data$SEX)

# for ease of interpretation - scale the responses
caro_data$UV_CHROMA <- scale(caro_data$UV_CHROMA)
caro_data$BRIGHTNESS <- scale(caro_data$BRIGHTNESS)
```

#### Mixed models

```{r message=FALSE, warning=FALSE}
library(lme4)
library(lmerTest)
uv_chroma1 <- lmer(
  UV_CHROMA ~ OH * SEX +
    MASS_14 +
    (1 | YEAR) + (1 | BOX) + (1 | BOX_OR),
  data = caro_data
)

uv_chroma1 <- lmer(
  UV_CHROMA ~ OH + SEX +
    MASS_14 +
    (1 | YEAR) + (1 | BOX) + (1 | BOX_OR),
  data = caro_data
)

brightness1 <- lmer(
  BRIGHTNESS ~ OH * SEX +
    MASS_14 +
    (1 | YEAR) + (1 | BOX) + (1 | BOX_OR),
  data = caro_data
)
```

The warning about model singularity is clear after inspecting the output - it arises due to one of the random effects contributing little to no variance. We will keep random effects structure constant - but follow-up analysis could involve dropping the random effects yielding zero variance estimates.

### 2B – Check assumptions

#### Residual v.s. fitted plot (marginal)

Note -  `re.form = NA` gives marginal residuals.

UV chroma:

```{r out.width = "50%", out.height = "50%"}
plot(uv_chroma1, resid(.) ~ predict(., re.form = NA))
```

Brightness:

```{r out.width = "50%", out.height = "50%"}
plot(brightness1, resid(.) ~ predict(., re.form = NA))
```


#### Scale-location plot

UV chroma:

```{r out.width = "50%", out.height = "50%"}
plot(uv_chroma1, sqrt(abs(resid(.))) ~ predict(., re.form = NA))
```

Brightness:

```{r out.width = "50%", out.height = "50%"}
plot(brightness1, sqrt(abs(resid(.))) ~ predict(., re.form = NA))
```

Upon visual inspection we can conclude, that assumptions of linearity and constant variance are satisfied.


### 3A – Replace statistical significance with ecological relevance by emphasising effect sizes

Start by plotting model estimates. We can use the `sjPlot` package to plot both the estimates (with their CIs) and the predicted (sex-specific) correlation with hatching date.

UV chroma:

```{r message=FALSE, warning=FALSE}
library(sjPlot)
library(ggplot2)

pred_plot1 <- plot_model(uv_chroma1,
  type = "pred",
  terms = c("OH", "SEX")
)
# always include confidence intervals
pred_plot1

est_plot1 <- plot_model(uv_chroma1) + ylim(-0.4, 0.4)
est_plot1
```

Brightness:

```{r message=FALSE, warning=FALSE}
library(sjPlot)

pred_plot2 <- plot_model(brightness1,
  type = "pred",
  terms = c("OH", "SEX")
)
# always include confidence intervals
pred_plot2

est_plot2 <- plot_model(brightness1) + ylim(-0.3, 2.5)
est_plot2
```


```{r  message=FALSE, warning=FALSE}
# library(ggplot2) 
# library(dplyr)

# pos = position_dodge(width=70) # dodge water

# plot_df <- emmeans_plot$data %>% 
#   mutate(fire_treatment = relevel(fire_treatment,"ub"))
 
# ggplot(plot_df, aes(days, yvar, color = water_treatment, 
#              shape = fire_treatment, linetype = fire_treatment))+
#   geom_point( position = pos, linewidth = 2 ) +
#   geom_path( position = pos , linewidth = 1) +
#   geom_errorbar(aes(ymin = LCL, ymax = UCL), position = pos, 
#                 alpha = 0.5, width = 0, linewidth = 2) +
#   theme_classic() +
#   xlim(0,1500) +
#   xlab("Time since experiment commenced (days)") + 
#   ylab("Mean species richness (+/- 95% CI) per mesocosm") +
#   theme(legend.position = "none",
#         axis.text = element_text( size = 12), 
#         axis.title = element_text( size = 14)) 
```

Next we calculate the desired effects and their confidence intervals, again using emmeans.

```{r}
# water by time changes
# em_water <- emmeans(rich_live,  ~ water_treatment + days , 
#                     at = list(days = c(587,1261), fire_treatment = "ub"))
```

Calculate all pairwise interactions between the two.

```{r}
# water_changes <- contrast(em_water, interaction = "pairwise", adjust = "mvt")
# water_changes
```


#### Results



#### Discussion

The analysis has demonstrated, according with the expectations, that Blue tit nestlings hatching later had darker feathers, and higher UV chroma. Both of these patterns are indicative of a lower amount of lutain in nestling diet, typical for seasonal decline in the quality and abundance of carotenoid-rich prey brought by the parents. These results suggest that environmental control of carotenoid-based colouration in this species is strong.



#### References


